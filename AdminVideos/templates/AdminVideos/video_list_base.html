{% extends "AdminVideos/index.html" %}

{% load static %}

{% block lista_platos %}

<!-- ESTE ES EL BOT칍N DE AGREGAR -->
<section class="w-100 text-white">
  <div class="container">
    <div class="d-flex justify-content-center flex-wrap gap-3">

      <!-- Bot칩n CUANDO LO SAQUE, SACAR TODA LA LOGICA QUE CARGA FORMULARIO EN MODAL -->
      <!-- <button class="btn btn-primary" id="btnNuevoPrincipal">
        Nuevo Plato Principal
      </button> -->

      {% with tipopag=request.GET.tipopag %}
      {% if tipopag == "Delivery" or tipopag == "Comerafuera" %}
        <a class="btn btn-primary w-75 w-sm-100 text-white border border-dark rounded text-center" href="{% url 'crear-lugar' %}?tipopag={{ tipopag|default:'Dash' }}">
            {% if tipopag and tipopag != "Dash" %}
              AGREGAR {{ tipopag }}
            {% else %}
              AGREGAR PLATO PRINCIPAL
            {% endif %}
          </a>
      
      {% else %}
        <a class="btn btn-primary w-75 w-sm-100 text-white border border-dark rounded  text-center" href="{% url 'videos-create' %}?tipopag={{ tipopag|default:'Dash' }}">
          {% if tipopag and tipopag != "Dash" %}
            AGREGAR {{ tipopag }}
          {% else %}
            AGREGAR PLATO PRINCIPAL
          {% endif %}
        </a>
      {% endif %}
    </div>
  </div>
</section>

<!-- <H5>{{platos_compartidos}}  </H5> -->

<!-- ESTAS SON LAS TARJETAS DE COMPARTIDOS -->
<section class="w-100 py-2">
  <div class="container">
      {% if not platos and tipopag != "Delivery" and tipopag != "Comerafuera" %}
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-geo-alt-fill"></i> No hay platos ingresados para mostrar.
      </div>
      {% else %}
          {% if platos_compartidos %}


          <div class="d-flex flex-wrap gap-2 justify-content-center text-center">
            {% for plato_compartido in platos_compartidos %}
              <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card h-100">
          
                  <img src="{{ plato_compartido.image_url }}" class="img-thumbnail" alt="Imagen">
          
                  <div class="card-body text-center">
                    <div class="position-absolute top-0 mt-1 start-50 translate-middle-x text-center text-white bg-dark rounded">
                      <h6 class="mb-0 small">{{ plato_compartido.nombre_plato }} de {{ plato_compartido.quien_comparte }}</h6>
                    </div>
          
                    <h6>{{ plato_compartido.mensaje }}</h6>
          
                    <div class="d-flex gap-1 align-items-center justify-content-center">
                      <a class="btn btn-primary btn-sm" href="{% url 'agregar-plato-compartido' plato_compartido.id_plato plato_compartido.mensaje_id %}">Agregar a mi lista</a>
                      <a class="btn btn-primary btn-sm" href="">Rechazar</a>
                    </div>
                  </div>
          
                </div>
              </div>
            {% endfor %}
          </div>
          




          {% endif %}
      {% endif %}
  </div>
</section>



<!-- ESTAS SON LAS TARJETAS DE PLATOS, SI ES QUE ESTAMOS EN PLATOS -->

<!-- <section class="w-100 text-white"> -->
<section class="w-100 text-white bg-light p-2 rounded shadow-sm">

  <div class="d-flex flex-wrap gap-1 align-items-start justify-content-center">
    {% for plato in platos %}
      

      <div class="card position-relative border-0 bg-transparent" style="width: 6rem;">                        
        
       <!-- <a href="{% url 'videos-update' plato.id %}">
        <img src="{{ plato.image_url }}"
            class="img-fluid {% if user.id == plato.propietario.id and not plato.proviene_de %}
                        sombra-verde
                        {% elif user.id == plato.propietario.id and plato.proviene_de %}
                        sombra-naranja
                        {% else %}
                        sombra-violeta
                        {% endif %}"  
            alt="Imagen del Plato"> 
      </a> -->

      <!-- <a href="#"
        data-bs-toggle="modal"
        data-bs-target="#asignarPlatoModal"
        onclick="setPlatoInfo('{{ plato.id }}', 'plato')">
        <img src="{{ plato.image_url }}"
            class="img-fluid {% if user.id == plato.propietario.id and not plato.proviene_de %}
                        sombra-verde
                        {% elif user.id == plato.propietario.id and plato.proviene_de %}
                        sombra-naranja
                        {% else %}
                        sombra-violeta
                        {% endif %}"  
            alt="Imagen del Plato"> 
      </a> -->

      <a href="#"
        data-bs-toggle="modal"
        data-bs-target="#asignarPlatoModal"
        onclick="setPlatoInfo('{{ plato.id }}', 'plato')"
        class="position-relative d-inline-block text-decoration-none">
        
        <img src="{{ plato.image_url }}"
            class="img-fluid {% if user.id == plato.propietario.id and not plato.proviene_de %}
                        sombra-verde
                        {% elif user.id == plato.propietario.id and plato.proviene_de %}
                        sombra-naranja
                        {% else %}
                        sombra-violeta
                        {% endif %}"  
            alt="Imagen del Plato"> 

        <!-- 칈cono + verde centrado -->
        <div class="position-absolute top-50 start-50 translate-middle text-success fs-3">
          <i class="fa-solid fa-plus-circle"></i>
        </div>
      </a>

      <div class="position-absolute start-50 translate-middle-x text-center text-white rounded px-2 py-1"
            style="top: 10%; background-color: rgba(0, 0, 0, 0.5);">

          <h6 class="mb-0 small">
            <!--  plato.nombre_plato }} -->
            <!--  plato.nombre_para_front }} -->

            {% if plato.variedades_count > 0 %}
               {{ plato.nombre_para_front }} 游늬 {{ plato.variedades_count|add:"1" }}
            {% else %}
              {{ plato.nombre_plato }}
            {% endif %}

          </h6>

      </div>


<!-- 
       

        <div class="d-inline-flex gap-2 align-items-center justify-content-center">
          {% if amigues %}
           <a href="#" data-bs-toggle="modal" data-bs-target="#compartirModal" onclick="setPlatoInfo('{{ plato.id }}', 'plato')">
            <i class="fa-solid fa-share-nodes"></i>
          </a> -->
          <a href="#"
            data-bs-toggle="modal"
            data-bs-target="#compartirModal"
            onclick="setPlatoInfo('{{ plato.id }}', 'plato')"
            class="position-absolute text-primary"
            style="top: 63%; left: 50%;">
            <i class="fa-solid fa-share-nodes"></i>
          </a>
          {% endif %}
          <!-- <a href="#" data-bs-toggle="modal" data-bs-target="#asignarPlatoModal"
            class="btn btn-sm btn-primary p-0" onclick="setPlatoInfo('{{ plato.id }}', 'plato')">
            Programar
          </a> -->
          <!-- <div class="position-absolute  translate-middle-x text-center" style="top: 62%; left: 43%;">
            <a href="#" data-bs-toggle="modal" data-bs-target="#asignarPlatoModal"
               
              onclick="setPlatoInfo('{{ plato.id }}', 'plato')">
              
            <i class="fa-regular fa-pen-to-square"></i>

            </a>
          </div> -->

          <div class="position-absolute translate-middle-x text-center" style="top: 62%; left: 35%;">

            <!-- PARA ABRIR UPDATE EN PANTALLA COMPLETA -->
            <a href="{% url 'videos-update' plato.id %}">
              <i class="fa-regular fa-pen-to-square"></i>
            </a> 

            <!-- PARA ABRIR UPDATE EN MODAL / AL BORRAR ESTO VER QU칄 M츼S EST츼 AL SERVICIO DEL MODAL EN ESTE TEMPLATE -->
            <!-- <a href="{% url 'videos-update' plato.id %}?tipopag={{ tipopag|default:'Dash' }}"
              class="btn-editar-plato"
              data-id="{{ plato.id }}"
              data-nombre="{{ plato.nombre_plato }}"
              data-url="{% url 'videos-update' plato.id %}?tipopag={{ tipopag|default:'Dash' }}"
              data-bs-toggle="modal"
              data-bs-target="#modalPlato"
              title="Editar plato">
              <i class="fa-regular fa-pen-to-square"></i>
            </a> -->



          </div>

          
          <!-- <a href="{% url 'eliminar-plato' plato.id %}" type="button" class="btn btn-sm btn-outline-secondary">Eliminar</a> -->

         <!-- Bot칩n eliminar posicionado -->
        <!-- <button
          type="button"
          class="btn btn-sm position-absolute text-primary"
          data-bs-toggle="modal"
          data-bs-target="#confirmDeleteModal"
          data-url="{% url 'eliminar-plato' plato.id %}"
          data-nombre="{{ plato.nombre_plato }}"
          style="top: 59%; right: 4%; font-size: 1rem;">
          <i class="fa-solid fa-trash-can"></i>
        </button> -->

      <a href="#"
        data-bs-toggle="modal"
        data-bs-target="#confirmDeleteModal"
        data-url="{% url 'eliminar-plato' plato.id %}"
        data-nombre="{{ plato.nombre_plato }}"
        class="position-absolute text-secondary"
        style="top: 62%; right: 12%; font-size: 1.1rem;"
        title="Eliminar">
        <i class="fa-solid fa-trash-can"></i>
      </a>

          
        </div>

        {% if plato.propietario != user %}
          <a href="{% url 'agregar-a-mi-lista' plato.id %}" class="btn btn-success"
            style="font-size: 12px; padding: 2px 5px;">AGREGAR A MI LISTA</a>
          <a href="{% url 'descartar-sugerido' plato.id %}" class="btn btn-success"
            style="font-size: 12px; padding: 2px 5px;">NO ME INTERESA ESTE PLATO</a>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</section>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminaci칩n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <form method="post" id="deleteForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>쮼st치s seguro de que quer칠s borrar <strong id="platoNombre"></strong>?</p>
          <p class="text-muted small mb-0">Esta acci칩n no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">S칤, borrar</button>
        </div>
      </form>

    </div>
  </div>
</div>


<!-- ESTAS SON LAS TARJETAS DE LUGARES, SI ES QUE ESTAMOS EN LUGARES -->
<section class="w-100 bg-info text-white">
  {% if tipopag == "Delivery" or tipopag == "Comerafuera" %}
    {% if not lugares %}
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-geo-alt-fill"></i> No hay lugares ingresados para mostrar.
      </div>
    {% else %}
      <div class="container p-0">
        <div class="row">
          {% for lugar in lugares %}
            <div class="col-6 col-sm-4 col-md-3">
                <div class="card h-100 shadow-sm rounded-4" style="font-size: 0.9rem; position: relative;">
                  <a href="{% url 'lugar-detail' lugar.id %}" style="position: relative; display: block;">
                    <img src="{{ lugar.image_url }}" class="card-img-top object-fit-cover rounded-top-4" alt="Imagen del Lugar"
                      style="height: 150px; object-fit: cover;">
                    <div
                      style="position: absolute; top: 0; left: 0; right: 0; height: 150px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); color: white; font-weight: bold; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                      {{ lugar.nombre }}
                    </div>
                  </a>

                  <div class="card-body text-center p-1">
                    <p class="text-muted mb-0" style="font-size: 0.8rem;">{{ lugar.direccion|default:"Sin direcci칩n" }}</p>

                    {% if amigues %}
                      <div class="mt-2">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#compartirModal"
                          onclick="setPlatoInfo('{{ lugar.id }}', 'lugar')" class="text-primary me-2">
                          <i class="fa-solid fa-share-nodes"></i>
                        </a>
                      </div>
                    {% endif %}
                    <a href="#" data-bs-toggle="modal" data-bs-target="#asignarPlatoModal" class="btn btn-sm btn-primary p-0"
                      onclick="setPlatoInfo('{{ lugar.id }}', 'lugar')" class="btn btn-sm btn-outline-primary">
                      Programar
                    </a>

                  </div>
                </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endif %}
</section>

{% endwith %}

  <!-- Modal para compartir plato -->
  <div class="modal fade" id="compartirModal" tabindex="-1" aria-labelledby="compartirModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- <div class="modal-header">
        <h5 class="modal-title" id="compartirModalLabel">Compartir plato</h5>
        
      </div> -->
        <div class="modal-body">
          <form method="post" action="{% url 'compartir-plato' %}">
            {% csrf_token %}

            <div class="mb-3">
              <h6>Compartir este plato {{ plato.id }} con:</h6>
              <select id="amigue-select" name="amigue" class="form-select" aria-label="Seleccionar amigue">
                {% for amigue in amigues %}
                <option value="{{ amigue }}">{{ amigue }}</option>
                {% endfor %}
              </select>
              <!-- Campo oculto donde se establecer치 el plato id din치micamente -->
              <input type="hidden" name="id_elemento" id="platoIdInputCompartir">

              <!-- Campo oculto para el tipo de elemento -->
              <input type="hidden" name="tipo_elemento" id="tipoObjetoCompartir">

            </div>

            <button type="submit" class="btn btn-primary">Compartir</button>

            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>

          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal para asignar plato -->
  <div class="modal fade" id="asignarPlatoModal" tabindex="-1" aria-labelledby="asignarPlatoLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
       <form
        id="asignarPlatoForm"
        action="{% url 'asignar-plato' %}"
        method="post"
        novalidate>

          {% csrf_token %}
          <div class="modal-body">


            <!-- Campo oculto para almacenar el d칤a activo -->
            <input type="hidden" name="dia" id="diaSeleccionado">

            <!-- Muestra el d칤a activo en el modal -->
            <h2>Asignar al d칤a <span id="diaActivoTexto"></span></h2>

            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>


            <!-- Selector del tipo de comida -->
            <div class="mb-1">
              <label for="comidaSeleccionada" class="form-label">Seleccionar comida:</label>
              <select name="comida" id="comidaSeleccionada" class="form-select">
                <option value="desayuno">Desayuno</option>
                <option value="almuerzo">Almuerzo</option>
                <option value="merienda">Merienda</option>
                <option value="cena">Cena</option>
              </select>

              <!-- Campo oculto para el ID del plato -->
              <input type="hidden" name="plato_id" id="platoIdInputAsignar">

              <!-- Campo oculto para el tipo de elemento -->
              <input type="hidden" name="tipo_elemento" id="tipoObjetoAsignar">

              <button type="submit" class="btn btn-primary">Asignar</button>


        </form>

      </div>
    </div>

  </div>
</div>
</div>

<script>
  function setPlatoInfo(platoId, tipo) {
    // Compartir
    document.getElementById("platoIdInputCompartir").value = platoId;
    document.getElementById("tipoObjetoCompartir").value = tipo;

    // Asignar
    document.getElementById("platoIdInputAsignar").value = platoId;
    document.getElementById("tipoObjetoAsignar").value = tipo;
  }
</script>

<!-- ELIMINAR PLATO -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('confirmDeleteModal');
  modalEl.addEventListener('show.bs.modal', function (event) {
    const trigger = event.relatedTarget;
    const url = trigger.getAttribute('data-url');
    const nombre = trigger.getAttribute('data-nombre');

    const form = modalEl.querySelector('#deleteForm');
    const nombreEl = modalEl.querySelector('#platoNombre');

    form.setAttribute('action', url);
    nombreEl.textContent = nombre || '';
  });
});
</script>

<!-- Modal para cargar el formulario din치micamente -->
<div class="modal fade" id="modalPlato" tabindex="-1" aria-labelledby="modalPlatoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPlatoLabel">Nuevo Plato</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body" id="modalPlatoBody">
        <!-- Aqu칤 se cargar치 el formulario din치micamente -->
      </div>
    </div>
  </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", function() {
  const modalEl = document.getElementById("modalPlato");
  const modalBody = document.getElementById("modalPlatoBody");
  const modal = new bootstrap.Modal(modalEl);

  const btnNuevo = document.getElementById("btnNuevoPrincipal");
  if (!btnNuevo) return;

  btnNuevo.addEventListener("click", function() {
    fetch("{% url 'videos-create' %}?tipopag=Principal", {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      modalBody.innerHTML = data.html;
      // 游녢 Nueva l칤nea clave: inicializa todas las funciones JS del form
      initPlatoForm(modalBody);
      modal.show();
    })
    .catch(err => console.error("Error cargando formulario:", err));
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = new bootstrap.Modal(document.getElementById("modalPlato"));
  const modalBody = document.getElementById("modalPlatoBody");
  const modalTitle = document.getElementById("modalPlatoLabel");

  // 游녤 Bot칩n "Editar"
  document.querySelectorAll(".btn-editar-plato").forEach(btn => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const url = this.getAttribute("data-url");
      const nombre = this.getAttribute("data-nombre");

      fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
        .then(response => response.json())
        .then(data => {
          modalBody.innerHTML = data.html;
          modalTitle.textContent = "Editar: " + nombre;
          initPlatoForm(modalBody);
          modal.show();
        })
        .catch(err => {
          console.error("Error cargando formulario de edici칩n:", err);
        });
    });
  });
});
</script>





{% endblock %}