{% extends "AdminVideos/base.html" %}
  
{% block pestanias-menues-platos %}

<!-- PESTAÑAS - MENÚES PROGRAMADOS - PLATOS -->

<!-- Tab Content -->
<div class="tab-content bg-white" id="diasTabContent">

  {% for dia in dias_desde_hoy %}
  <div class="tab-pane {% if dia_activo == dia|date:'Y-m-d' %}active{% elif forloop.first and not dia_activo %}active{% endif %}"
       id="tab-content-{{ dia|date:'Y-m-d' }}" role="tabpanel" aria-labelledby="tab-{{ dia|date:'Y-m-d' }}">

    <div class="text-dark p-1 small">
      <div class="position-relative">

        <div class="border border-2 border-primary rounded p-2 mt-2 bg-light shadow-sm">
          <div class="row align-items-start">
            <div class="col py-2">

              {% if dia in platos_dia_x_dia %}
                <!-- Si hay platos programados para este día, los mostramos -->
                {% for dia_plato in platos_dia_x_dia.items %}
                  {% if dia_plato.0 == dia %}

                    {# ========================= #}
                    {# DESKTOP / TABLET: 4 columnas (como ahora) #}
                    {# ========================= #}
                    <div class="d-none d-md-block">
                      <div class="row gx-0">

                        <!-- Desayuno -->
                        <div class="col-md-3">
                          <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Desayuno</h6>
                          {% if dia_plato.1.desayuno %}
                            {% for plato in dia_plato.1.desayuno %}
                              <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                  &nbsp; {{ plato.nombre }}
                                </a>

                                <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'desayuno' %}"
                                   title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                  <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                </a>

                                <a href="{% url 'eliminar-programado' plato.plato_id 'desayuno' dia %}"
                                   class="btn btn-sm p-0" title="Eliminar">
                                  <i class="fa-solid fa-trash-can"></i>
                                </a>

                                <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                  class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                  title="Extras (guarnición/salsa/postre)">
                                  <i class="fa-solid fa-list"></i>
                                </a>


                              </div>
                            {% endfor %}
                          {% else %}
                            <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                          {% endif %}
                        </div>

                        <!-- Almuerzo -->
                        <div class="col-md-3">
                          <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Almuerzo</h6>
                          {% if dia_plato.1.almuerzo %}
                            {% for plato in dia_plato.1.almuerzo %}
                              <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                  &nbsp; {{ plato.nombre }}
                                </a>

                                <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'almuerzo' %}"
                                   title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                  <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                </a>

                                <a href="{% url 'eliminar-programado' plato.plato_id 'almuerzo' dia %}"
                                   class="btn btn-sm p-0" title="Eliminar">
                                  <i class="fa-solid fa-trash-can"></i>
                                </a>

                                <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                  class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                  title="Extras (guarnición/salsa/postre)">
                                  <i class="fa-solid fa-list"></i>
                                </a>

                              </div>
                            {% endfor %}
                          {% else %}
                            <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                          {% endif %}
                        </div>

                        <!-- Merienda -->
                        <div class="col-md-3">
                          <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Merienda</h6>
                          {% if dia_plato.1.merienda %}
                            {% for plato in dia_plato.1.merienda %}
                              <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                  &nbsp; {{ plato.nombre }}
                                </a>

                                <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'merienda' %}"
                                   title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                  <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                </a>

                                <a href="{% url 'eliminar-programado' plato.plato_id 'merienda' dia %}"
                                   class="btn btn-sm p-0" title="Eliminar">
                                  <i class="fa-solid fa-trash-can"></i>
                                </a>

                                <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                  class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                  title="Extras (guarnición/salsa/postre)">
                                  <i class="fa-solid fa-list"></i>
                                </a>

                              </div>
                            {% endfor %}
                          {% else %}
                            <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                          {% endif %}
                        </div>

                        <!-- Cena -->
                        <div class="col-md-3">
                          <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Cena</h6>
                          {% if dia_plato.1.cena %}
                            {% for plato in dia_plato.1.cena %}
                              <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                  &nbsp; {{ plato.nombre }}
                                </a>

                                <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'cena' %}"
                                   title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                  <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                </a>

                                <a href="{% url 'eliminar-programado' plato.plato_id 'cena' dia %}"
                                   class="btn btn-sm p-0" title="Eliminar">
                                  <i class="fa-solid fa-trash-can"></i>
                                </a>

                                <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                  class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                  title="Extras (guarnición/salsa/postre)">
                                  <i class="fa-solid fa-list"></i>
                                </a>


                              </div>
                            {% endfor %}
                          {% else %}
                            <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                          {% endif %}
                        </div>

                      </div>
                    </div>

                    {# ========================= #}
                    {# MOBILE: Carousel 4 slides (1 comida por slide) #}
                    {# ========================= #}
                    <div class="d-block d-md-none">
                        <div id="comidasCarousel-{{ dia|date:'Y-m-d' }}"
                            class="carousel slide comidas-carousel"
                            data-bs-touch="true"
                            data-bs-wrap="true"
                            data-bs-ride="false"
                            data-bs-interval="false">

                        
                            <div class="carousel-inner">

                          <!-- Slide 1: Desayuno -->
                          <div class="carousel-item">
                            <div class="p-1">
                              <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Desayuno</h6>
                              {% if dia_plato.1.desayuno %}
                                {% for plato in dia_plato.1.desayuno %}
                                  <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                    <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                      &nbsp; {{ plato.nombre }}
                                    </a>

                                    <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'desayuno' %}"
                                       title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                      <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                    </a>

                                    <a href="{% url 'eliminar-programado' plato.plato_id 'desayuno' dia %}"
                                       class="btn btn-sm p-0" title="Eliminar">
                                      <i class="fa-solid fa-trash-can"></i>
                                    </a>

                                    <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                      class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                      title="Extras (guarnición/salsa/postre)">
                                      <i class="fa-solid fa-list"></i>
                                    </a>

                                  </div>
                                {% endfor %}
                              {% else %}
                                <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Slide 2: Almuerzo -->
                          <div class="carousel-item active">
                            <div class="p-1">
                              <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Almuerzo</h6>
                              {% if dia_plato.1.almuerzo %}
                                {% for plato in dia_plato.1.almuerzo %}
                                  <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                    <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                      &nbsp; {{ plato.nombre }}
                                    </a>

                                    <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'almuerzo' %}"
                                       title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                      <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                    </a>

                                    <a href="{% url 'eliminar-programado' plato.plato_id 'almuerzo' dia %}"
                                       class="btn btn-sm p-0" title="Eliminar">
                                      <i class="fa-solid fa-trash-can"></i>
                                    </a>

                                    <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                      class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                      title="Extras (guarnición/salsa/postre)">
                                      <i class="fa-solid fa-list"></i>
                                    </a>


                                  </div>
                                {% endfor %}
                              {% else %}
                                <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Slide 3: Merienda -->
                          <div class="carousel-item">
                            <div class="p-1">
                              <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Merienda</h6>
                              {% if dia_plato.1.merienda %}
                                {% for plato in dia_plato.1.merienda %}
                                  <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                    <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                      &nbsp; {{ plato.nombre }}
                                    </a>

                                    <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'merienda' %}"
                                       title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                      <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                    </a>

                                    <a href="{% url 'eliminar-programado' plato.plato_id 'merienda' dia %}"
                                       class="btn btn-sm p-0" title="Eliminar">
                                      <i class="fa-solid fa-trash-can"></i>
                                    </a>


                                    <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                      class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                      title="Extras (guarnición/salsa/postre)">
                                      <i class="fa-solid fa-list"></i>
                                    </a>

                                  </div>
                                {% endfor %}
                              {% else %}
                                <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                              {% endif %}
                            </div>
                          </div>

                          <!-- Slide 4: Cena -->
                          <div class="carousel-item">
                            <div class="p-1">
                              <h6 class="fw-bold ms-1 bg-primary text-white p-1 rounded">Cena</h6>
                              {% if dia_plato.1.cena %}
                                {% for plato in dia_plato.1.cena %}
                                  <div class="mb-1 ms-1 d-flex align-items-center text-primary">
                                    <a href="{% url 'videos-update' plato.plato_id %}" class="text-decoration-none me-2">
                                      &nbsp; {{ plato.nombre }}
                                    </a>

                                    <a href="{% url 'fijar-o-eliminar-habito' plato.plato_id 'cena' %}"
                                       title="{% if plato.fijo %}Eliminar hábito{% else %}Fijar hábito{% endif %}">
                                      <i class="bi bi-pin-angle-fill ms-2 fa-lg {% if plato.fijo %}text-success{% else %}text-secondary{% endif %}"></i>
                                    </a>

                                    <a href="{% url 'eliminar-programado' plato.plato_id 'cena' dia %}"
                                       class="btn btn-sm p-0" title="Eliminar">
                                      <i class="fa-solid fa-trash-can"></i>
                                    </a>

                                    <a href="{% url 'menuitem-extras-modal' plato.menuitem_id %}"
                                      class="btn btn-sm p-0 ms-2 text-primary js-extras"
                                      title="Extras (guarnición/salsa/postre)">
                                      <i class="fa-solid fa-list"></i>
                                    </a>


                                  </div>
                                {% endfor %}
                              {% else %}
                                <p class="mb-1 ms-1 d-flex align-items-center">No hay platos programados.</p>
                              {% endif %}
                            </div>
                          </div>

                        </div>

                        <!-- Controles -->
                        <button class="carousel-control-prev" type="button"
                                data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}" data-bs-slide="prev">
                          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Anterior</span>
                        </button>

                        <button class="carousel-control-next" type="button"
                                data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}" data-bs-slide="next">
                          <span class="carousel-control-next-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Siguiente</span>
                        </button>

                      </div>

                      <!-- Indicador simple con links a cada slide -->
                      <div class="text-center mt-1" style="font-size:.7rem;">
                        <a href="#"
                          class="text-muted mx-1"
                          data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}"
                          data-bs-slide-to="0">
                          Desayuno
                        </a>
                        ·
                        <a href="#"
                          class="text-muted mx-1"
                          data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}"
                          data-bs-slide-to="1">
                          Almuerzo
                        </a>
                        ·
                        <a href="#"
                          class="text-muted mx-1"
                          data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}"
                          data-bs-slide-to="2">
                          Merienda
                        </a>
                        ·
                        <a href="#"
                          class="text-muted mx-1"
                          data-bs-target="#comidasCarousel-{{ dia|date:'Y-m-d' }}"
                          data-bs-slide-to="3">
                          Cena
                        </a>
                      </div>
                  </div>


                  {% endif %}
                {% endfor %}
              {% else %}
                <h3 class="text-muted text-center mt-1" style="font-size: 1rem;">
                  Aún no programaste ningún plato para este día.
                </h3>
              {% endif %}

            </div>
          </div>
        </div>

        <span class="menu-programado-badge position-absolute top-0 start-50 translate-middle text-primary">
            <a href="/random-dia/{{ dia|date:'l'|slice:':2'|upper }}/" class="btn btn-sm text-danger p-0 me-1">
                <span class="material-symbols-outlined" style="font-size: 20px;">wand_shine</span>
            </a>
            <span class="menu-programado-text">Menú programado</span>

            {% if dia in platos_dia_x_dia %}
                <!-- aquí tu botón eliminar menú si lo activás -->
            {% endif %}
        </span>


        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-info">{{ message }}</div>
          {% endfor %}
        {% endif %}

      </div>
    </div>
  </div>
  {% endfor %}

  <div class="border border-primary rounded p-2 position-relative m-2">
    <small class="position-absolute top-0 start-50 translate-middle bg-white px-3 text-primary"
           style="transform: translate(-50%, -50%);">
      Platos
    </small>

    <div class="shadow rounded p-2 m-2 mb-0">
      {% block filtro %}{% endblock %}
    </div>

    <div class="my-3">
      {% block principal %}{% endblock %}
    </div>
  </div>

</div>

<!-- FIN DE PESTAÑAS - MENÚES PROGRAMADOS - PLATOS -->

{# =========================================================
   MODAL: Extras del plato programado
   - Se abre por AJAX
   - El contenido se inyecta dinámicamente
   - SOLO debe existir UNA VEZ en el DOM
   ========================================================= #}

<div class="modal fade" id="extrasModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">

    {# Acá se va a cargar el HTML del partial (formset de extras) #}
    <div class="modal-content" id="extrasModalContent">
      {# vacío a propósito #}
    </div>

  </div>
</div>

<script>
/* =========================================================
   ABRIR MODAL DE EXTRAS (AJAX)
   - Escucha clicks en botones .js-extras
   - Carga el HTML del modal vía fetch
   - Abre el modal Bootstrap
   ========================================================= */

document.addEventListener("click", async function (e) {

  // Buscamos si el click vino de un botón "Extras"
  const btn = e.target.closest(".js-extras");
  if (!btn) return; // si no, salimos

  e.preventDefault(); // evita navegar al href

  try {
    // Pedimos el HTML del modal al backend
    const response = await fetch(btn.href, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const html = await response.text();

    // Inyectamos el contenido en el modal
    const content = document.getElementById("extrasModalContent");
    content.innerHTML = html;

    // Abrimos el modal
    const modalEl = document.getElementById("extrasModal");
    bootstrap.Modal.getOrCreateInstance(modalEl).show();

  } catch (err) {
    console.error("Error cargando extras:", err);
  }
});
</script>

<script>
/* =========================================================
   GUARDAR EXTRAS (SUBMIT AJAX)
   - Envía el formset por fetch
   - Si hay errores: re-renderiza el modal
   - Si OK: cierra el modal
   ========================================================= */

document.addEventListener("submit", async function (e) {

  // Solo interceptamos el form del modal
  const form = e.target.closest("#extrasForm");
  if (!form) return;

  e.preventDefault();

  try {
    const response = await fetch(form.action, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      body: new FormData(form),
    });

    // Si todo OK → cerrar modal
    if (response.ok) {
      const modalEl = document.getElementById("extrasModal");
      bootstrap.Modal.getInstance(modalEl)?.hide();
      return;
    }

    // Si hay errores → backend devuelve HTML del modal
    const data = await response.json();
    if (data.html) {
      document.getElementById("extrasModalContent").innerHTML = data.html;
    }

  } catch (err) {
    console.error("Error guardando extras:", err);
  }
});
</script>
 
{% endblock %}
