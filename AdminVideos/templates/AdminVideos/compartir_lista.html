{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap (usa el mismo que cargás en base normalmente) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .striked { text-decoration: line-through; opacity: .65; }
    .item-line { transition: opacity .2s ease; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <h5 class="m-0">Lista de compras</h5>
      <button class="btn btn-sm btn-outline-secondary ms-auto" id="btn-clear">Borrar tildados</button>
    </div>

    {% if items %}
      <div class="card">
        <ul class="list-group list-group-flush" id="lista">
          {% for it in items %}
          <li class="list-group-item py-2 item-line d-flex align-items-start gap-2">
            <input class="form-check-input mt-1 flex-shrink-0 item-check" type="checkbox" id="chk-{{ forloop.counter0 }}">
            <label class="form-check-label flex-grow-1" for="chk-{{ forloop.counter0 }}">
              <div class="fw-semibold item-nombre">{{ it.nombre }}</div>
              {% if it.comentario %}
              <div class="small text-muted item-comentario">{{ it.comentario }}</div>
              {% endif %}
            </label>
          </li>
          {% endfor %}
        </ul>
      </div>
      <p class="text-muted small mt-2">Tip: el tilde se guarda en este navegador automáticamente.</p>
    {% else %}
      <div class="alert alert-info">No hay ingredientes.</div>
    {% endif %}
  </div>

  <script>
    (function() {
      const token = "{{ token|escapejs }}";
      const KEY = "lista_compartida::" + token;
      const listaEl = document.getElementById("lista");
      const btnClear = document.getElementById("btn-clear");

      function loadState() {
        try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
        catch(_) { return {}; }
      }
      function saveState(state) {
        try { localStorage.setItem(KEY, JSON.stringify(state)); }
        catch(_) {}
      }

      const state = loadState(); // { "chk-0": true, "chk-1": false, ... }

      // aplicar estado inicial
      document.querySelectorAll(".item-check").forEach(chk => {
        const id = chk.id;
        if (state[id]) {
          chk.checked = true;
          chk.closest(".item-line")?.classList.add("striked");
        }
        chk.addEventListener("change", () => {
          state[id] = chk.checked ? true : false;
          if (chk.checked) {
            chk.closest(".item-line")?.classList.add("striked");
          } else {
            chk.closest(".item-line")?.classList.remove("striked");
          }
          saveState(state);
        });
      });

      // botón para limpiar todo
      btnClear?.addEventListener("click", () => {
        document.querySelectorAll(".item-check").forEach(chk => {
          chk.checked = false;
          chk.closest(".item-line")?.classList.remove("striked");
          state[chk.id] = false;
        });
        saveState(state);
      });
    })();
  </script>
</body>
</html>
