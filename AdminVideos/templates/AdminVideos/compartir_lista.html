{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .striked { text-decoration: line-through; opacity: .65; }
    .item-line { transition: opacity .2s ease; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <h5 class="m-0">Lista de compras</h5>
      <button class="btn btn-sm btn-outline-secondary ms-auto" id="btn-clear">Borrar tildados</button>
    </div>

    {% if items %}
      <div class="card">
        <ul class="list-group list-group-flush" id="lista">
          {% for it in items %}
          <li class="list-group-item py-2 item-line d-flex align-items-start gap-2"
              data-nombre="{{ it.nombre|escapejs }}">
            <input class="form-check-input mt-1 flex-shrink-0 item-check"
                   type="checkbox" id="chk-{{ forloop.counter0 }}"
                   data-nombre="{{ it.nombre|escapejs }}">
            <label class="form-check-label flex-grow-1" for="chk-{{ forloop.counter0 }}">
              <div class="fw-semibold item-nombre">{{ it.nombre }}</div>
              {% if it.comentario %}
              <div class="small text-muted item-comentario">{{ it.comentario }}</div>
              {% endif %}
            </label>
          </li>
          {% endfor %}
        </ul>
      </div>
      <p class="text-muted small mt-2">Tip: el tilde se guarda en este navegador autom√°ticamente.</p>
    {% else %}
      <div class="alert alert-info">No hay ingredientes.</div>
    {% endif %}
  </div>

<script>
(function() {
  const token = "{{ token|escapejs }}";           // localStorage
  const KEY   = "lista_compartida::" + token;
  const API   = "{% url 'api-toggle-item' token=api_token %}";  
  
  const listaEl = document.getElementById("lista");
  const btnClear= document.getElementById("btn-clear");

  function loadState() {
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch(_) { return {}; }
  }
  function saveState(state) {
    try { localStorage.setItem(KEY, JSON.stringify(state)); }
    catch(_) {}
  }
  async function postToggle(nombre, checked) {
    try {
      await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, checked })
      });
    } catch(e) {
      console.error("No se pudo persistir el cambio", e);
    }
  }

  const state = loadState();

  document.querySelectorAll(".item-check").forEach((chk) => {
    const line   = chk.closest(".item-line");
    const nombre = chk.dataset.nombre || line?.dataset.nombre || "";

    // estado inicial desde localStorage
    if (state[chk.id]) {
      chk.checked = true;
      line.classList.add("striked");
    }

    chk.addEventListener("change", () => {
      const checked = chk.checked;
      state[chk.id] = checked;
      line.classList.toggle("striked", checked);
      saveState(state);
      postToggle(nombre, checked);
    });
  });

  btnClear?.addEventListener("click", () => {
    document.querySelectorAll(".item-check").forEach(chk => {
      const line   = chk.closest(".item-line");
      const nombre = chk.dataset.nombre || line?.dataset.nombre || "";
      chk.checked = false;
      line?.classList.remove("striked");
      state[chk.id] = false;
      postToggle(nombre, false);
    });
    saveState(state);
  });
})();
</script>
</body>
</html>
