{% extends "AdminVideos/base.html" %}
{% load static widget_tweaks %}

{% block principal %}
<div class="container my-5">
    <h4 class="text-center">Plato Principal - Refactorización</h4>

    <!-- Mostrar errores de forma combinada -->
    {% if form.errors or ingrediente_formset.errors %}
    <div class="alert alert-danger">
        <strong>Errores:</strong>
        <ul>
        {% for f in form %}{% for e in f.errors %}<li><strong>{{ f.label }}:</strong> {{ e }}</li>{% endfor %}{% endfor %}
        {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
        {% for fs in ingrediente_formset %}{% for f in fs %}{% for e in f.errors %}<li><strong>{{ f.label }}:</strong> {{ e }}</li>{% endfor %}{% endfor %}{% for e in fs.non_field_errors %}<li>{{ e }}</li>{% endfor %}{% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {% for field in form %}
            {{ field|add_class:"form-control mb-3" }}
        {% endfor %}

        <!-- Botón modal ingredientes -->
        <button type="button" class="btn btn-outline-secondary mb-3" data-bs-toggle="modal" data-bs-target="#ingredienteModal">
            Agregar Ingrediente
        </button>

        <!-- Lista visible de ingredientes -->
        <ul id="ingredientes-list" class="list-group mb-3">
            {% for f in ingrediente_formset %}
                {% if f.nombre_ingrediente.value %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ f.nombre_ingrediente.value }} - {{ f.cantidad.value }} {{ f.unidad.value }}
                </li>
                {% endif %}
            {% endfor %}
        </ul>

        <!-- Contenedor oculto para Django -->
        <div id="ingredientes-hidden" style="display:none;">
            {{ ingrediente_formset.management_form }}
            {% for f in ingrediente_formset %}{{ f.as_p }}{% endfor %}
        </div>

        <!-- Tipos de plato -->
        {% if items %}
        <div class="mb-3 border rounded p-3 bg-light{% if form.tipos.errors %} border-danger{% endif %}">
            <label class="form-label d-block">Tipo de plato:</label>
            {% for tipo in items %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="tipos" id="id_tipos_{{ forloop.counter0 }}"
                       value="{{ tipo }}" {% if tipo == tipopag or tipo in form.tipos.value %}checked{% endif %}>
                <label class="form-check-label" for="id_tipos_{{ forloop.counter0 }}">{{ tipo }}</label>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <button type="submit" class="btn btn-success mt-3">Guardar</button>
    </form>
</div>

<!-- Modal ingredientes -->
<div class="modal fade" id="ingredienteModal" tabindex="-1" aria-labelledby="ingredienteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Ingrediente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="modal-nombre" class="form-label">Ingrediente</label>
            <select id="modal-nombre" class="form-select" style="width:100%"></select>
        </div>
        <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="text" id="modal-cantidad" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Unidad</label>
            {{ ingrediente_formset.empty_form.unidad|add_class:"form-select"|attr:"id:modal-unidad" }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarIngrediente">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const list = document.getElementById("ingredientes-list");
    const hidden = document.getElementById("ingredientes-hidden");
    const totalFormsInput = document.getElementById("id_ingredientes_en_plato-TOTAL_FORMS");
    let totalForms = parseInt(totalFormsInput.value);

    // Select2 AJAX
    $('#ingredienteModal').on('shown.bs.modal', function() {
        $('#modal-nombre').select2({
            placeholder: 'Selecciona un ingrediente',
            ajax: {
                url: '/api/ingredientes/',
                dataType: 'json',
                delay: 250,
                data: params => ({ q: params.term || '' }),
                processResults: data => ({ results: data.map(item => ({ id:item.id, text:item.nombre })) }),
                cache: true
            },
            minimumInputLength: 0,
            dropdownParent: $('#ingredienteModal'),
            allowClear: true
        }).select2('open');
    });

    document.getElementById("guardarIngrediente").addEventListener("click", function() {
        const nombre = $('#modal-nombre').select2('data')[0].text;
        const cantidad = document.getElementById("modal-cantidad").value;
        const unidad = document.getElementById("modal-unidad").value;

        list.insertAdjacentHTML("beforeend",
            `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${nombre} - ${cantidad} ${unidad}
            </li>`
        );

        hidden.insertAdjacentHTML("beforeend", `
            <input type="hidden" name="ingredientes_en_plato-${totalForms}-nombre_ingrediente" value="${nombre}">
            <input type="hidden" name="ingredientes_en_plato-${totalForms}-cantidad" value="${cantidad}">
            <input type="hidden" name="ingredientes_en_plato-${totalForms}-unidad" value="${unidad}">
        `);

        totalForms++;
        totalFormsInput.value = totalForms;

        // Reset modal
        $('#modal-nombre').val(null).trigger('change');
        document.getElementById("modal-cantidad").value = "";
        document.getElementById("modal-unidad").value = "";

        bootstrap.Modal.getInstance(document.getElementById("ingredienteModal")).hide();
    });
});
</script>
{% endblock %}
