
{% extends "AdminVideos/base.html" %}
{% load static %}
{% block principal %}

<form action="{% url 'menu-elegido' %}" method="post">  {# ⬅️ FORM INICIO #}
  {% csrf_token %}

  <div class="row g-4">

    <!-- Columna: Menúes programados -->
    <div class="col-12 col-lg-4">
      <section>
        <h4 class="mb-3">Menúes programados</h4>

        {% for menu in menues_del_usuario %}
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">
                {{ menu.el_dia_en_que_comemos|date:"l"|capfirst }} {{ menu.el_dia_en_que_comemos|date:"j" }}
              </span>
            </div>

            <div class="list-group list-group-flush">
              {% for comida, platos in menu.platos_que_comemos.items %}
                {% if platos %}
                  <div class="list-group-item">
                    <h6 class="mb-2 text-primary">{{ comida|title }}</h6>

                    {% for plato in platos %}
                      {% if plato.tipo != "lugar" %}
                        <div class="form-check mb-2">
                          <input
                            type="checkbox"
                            id="plato{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                            name="plato_seleccionado"
                            value="{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                            class="form-check-input"
                            {% if plato.elegido %}checked{% endif %}>
                          <label class="form-check-label" for="plato{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}">
                            {{ plato.plato }}
                          </label>
                        </div>

                        {% if plato.variedades %}
                          <div class="ps-4 mt-2 border-start">
                            {% for variedad_id, variedad in plato.variedades.items %}
                              <div class="form-check mb-1">
                                <!-- <input
                                  type="checkbox"
                                  id="variedad{{ variedad_id }}_{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                                  name="variedad_seleccionada"   {# ⬅️ MISMO name para poder usar getlist #}
                                  value="{{ plato.id_plato }}|{{ variedad.nombre }}"
                                  class="form-check-input"
                                  {% if variedad.elegido %}checked{% endif %}> -->

                                  <input
                                    type="checkbox"
                                    id="variedad{{ variedad_id }}_{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                                    name="variedad_seleccionada"
                                    value="{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}|{{ variedad.nombre }}"
                                    class="form-check-input"
                                    {% if variedad.elegido %}checked{% endif %}>
                                <label class="form-check-label" for="variedad{{ variedad_id }}_{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}">
                                  → {{ variedad.nombre }}
                                </label>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}

                      {% else %}
                        <div class="text-muted fst-italic">››› {{ plato.plato }}</div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% empty %}
          <div class="alert alert-info">No hay platos asignados.</div>
        {% endfor %}

      </section>
    </div>

    <!-- Columna: Edita lista de compras -->
    <div class="col-12 col-lg-4">
      <section>
        <h4 class="mb-2">Marcá lo que necesites comprar:</h4>

        {% if ingredientes_con_tengo_y_comentario %}
          <div class="card">
            <ul class="list-group list-group-flush">
              {% for ingrediente, valor in ingredientes_con_tengo_y_comentario.items %}
                <li class="list-group-item py-1 px-2">
                  <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">

                    <div class="form-check m-0 flex-grow-1">
                      <input 
                        class="form-check-input me-1" 
                        type="checkbox" 
                        id="ing-{{ forloop.counter }}"      {# ⬅️ IDs sin espacios #}
                        name="ingrediente_a_comprar"
                        value="{{ ingrediente }}"
                        {% if valor.estado == "no-tengo" %}checked{% endif %}>
                      <label class="form-check-label small" for="ing-{{ forloop.counter }}">
                        {{ ingrediente }}
                      </label>
                    </div>

                    <div class="input-group input-group-sm">
                      <input 
                        type="text"
                        id="ing-{{ forloop.counter }}_comentario"
                        name="{{ ingrediente }}_comentario"
                        value="{{ valor.comentario }}"
                        class="form-control"
                        placeholder="Comentario">
                      <button 
                        class="btn btn-outline-secondary" 
                        type="button" 
                        onclick="this.previousElementSibling.value=''">
                        &times;
                      </button>
                    </div>

                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="alert alert-info py-1 px-2 small">No hay ingredientes para editar</div>
        {% endif %}
      </section>
    </div>

    <!-- Columna: Lista de compras -->
    <!-- Columna: Lista de compras (compacta) -->
<div class="col-12 col-lg-4">
  <section>
    <h6 class="mb-2">Lista de compras</h6> <!-- título más chico -->

    {% if lista_de_compras %}
      <div class="card mb-2">
        <ul class="list-group list-group-flush">
          {% for item in lista_de_compras %}
            <li class="list-group-item py-1 px-2 d-flex align-items-center small">
              <span class="me-1">•</span>{{ item }}
            </li>
          {% endfor %}
        </ul>
      </div>

      

     <!-- Botón WhatsApp existente -->
<a class="btn btn-success w-100 mb-2"
   href="https://wa.me/5491145342640?text={{ mensaje_whatsapp }}"
   target="_blank" rel="noopener">
  Enviar lista por WhatsApp
</a>

<!-- NUEVO: botón que abre el modal de opciones -->
<button type="button" class="btn btn-outline-secondary w-100" id="btnShare">
  Compartir lista de compras
</button>

  <!-- (Opcional) input para copiar el link directamente -->
  <div class="input-group input-group-sm mt-2">
    <input class="form-control" value="{{ share_url }}" readonly onclick="this.select()">
    <button class="btn btn-outline-secondary" type="button"
            onclick="navigator.clipboard?.writeText('{{ share_url }}')">
      Copiar link
    </button>
  </div>
    {% else %}
      <span class="alert alert-info py-1 px-2 small">No hay ingredientes para comprar</span>
    {% endif %}
  </section>
</div>


  <!-- Submit global (DENTRO del form) -->
  <!-- <div class="text-center mt-4">
    <button type="submit" class="btn btn-primary px-4">Actualizar</button>
  </div> -->

  <div class="text-center mt-4 position-sticky" style="bottom: 1rem;">
    <button type="submit" class="btn btn-primary px-4">Actualizar</button>
  </div>


</form>  {# ⬅️ FORM FIN #}

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel">Compartir lista de compras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        ¿Qué querés hacer?
        <ul class="small mt-2 mb-0">
          <li>Enviar el link por WhatsApp</li>
          <li>Ir a la página de la lista (tildable)</li>
        </ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="goList">Ir a la lista</button>
        <button type="button" class="btn btn-success" id="goWhatsApp">Mandar por WhatsApp</button>
      </div>

    </div>
  </div>
</div>

<script>
  (function () {
    const shareBtn   = document.getElementById('btnShare');
    const shareModal = document.getElementById('shareModal');
    const goWA       = document.getElementById('goWhatsApp');
    const goList     = document.getElementById('goList');

    // Abrir modal al click
    shareBtn?.addEventListener('click', function (e) {
      e.preventDefault();
      const modal = new bootstrap.Modal(shareModal);
      modal.show();
    });

    // Ir a la página de la lista (nueva pestaña)
    goList?.addEventListener('click', function () {
      const url = "{{ share_url }}";
      window.open(url, '_blank', 'noopener');
    });

    // Enviar link por WhatsApp (sin número específico)
    goWA?.addEventListener('click', function () {
      const link = "{{ share_url }}";
      const msg  = `Te comparto mi lista de compras:\n${link}`;
      const wa   = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(wa, '_blank', 'noopener');
    });
  })();
</script>

<script>
  (function() {
    // El token público está en la URL. Lo tomamos del path:
    const tokenFromPath = window.location.pathname.split("/").filter(Boolean).pop(); 
    // ej: /lista/compartir/2f3d...-...-.../  → "2f3d...-...-..."
    const API_URL = `/api/lista/compartir/${tokenFromPath}/toggle/`;

    function toggleBackend(nombre, checked) {
      fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nombre, checked })
      }).catch(()=>{ /* silencioso */});
    }

    const token = "{{ token|escapejs }}";
    const KEY = "lista_compartida::" + token;
    const btnClear = document.getElementById("btn-clear");
    const state = JSON.parse(localStorage.getItem(KEY) || "{}");

    // aplicar estado y bind
    document.querySelectorAll(".item-check").forEach(chk => {
      const li = chk.closest(".item-line");
      const nombre = li.querySelector(".item-nombre")?.textContent?.trim() || "";

      if (state[chk.id]) {
        chk.checked = true;
        li.classList.add("striked");
      }

      chk.addEventListener("change", () => {
        state[chk.id] = chk.checked;
        li.classList.toggle("striked", chk.checked);
        localStorage.setItem(KEY, JSON.stringify(state));
        // Persistir en servidor
        toggleBackend(nombre, chk.checked);
      });
    });

    btnClear?.addEventListener("click", () => {
      document.querySelectorAll(".item-check").forEach(chk => {
        const li = chk.closest(".item-line");
        const nombre = li.querySelector(".item-nombre")?.textContent?.trim() || "";
        chk.checked = false;
        li.classList.remove("striked");
        state[chk.id] = false;
        toggleBackend(nombre, false);
      });
      localStorage.setItem(KEY, JSON.stringify(state));
    });
  })();
</script>
 

{% endblock %}
