
{% extends "AdminVideos/base.html" %}
{% load static %}
{% block pestanias-menues-platos %}

<!-- <form action="{% url 'menu-elegido' %}" method="post">  {# ⬅️ FORM INICIO #} -->
<form id="frm-menu" action="{% url 'menu-elegido' %}" method="post">

  {% csrf_token %}

  <input type="hidden" name="post_origen" id="post_origen" value="">

  <div class="row g-1 ml-1">


    <!-- Columna: Menúes programados -->
   
    <div class="col-12 col-md-6">


      <section>
        <h6 class="mb-1">Menúes programados</h6>

        {% for menu in menues_del_usuario %}
          <div class="card mb-3 mr-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">
                {{ menu.el_dia_en_que_comemos|date:"l"|capfirst }} {{ menu.el_dia_en_que_comemos|date:"j" }}
              </span>
            </div>

            <div class="list-group list-group-flush">
              {% for comida, platos in menu.platos_que_comemos.items %}
                {% if platos %}
                  <div class="list-group-item">
                    <h6 class="mb-1 text-primary">{{ comida|title }}</h6>

                    {% for plato in platos %}
                      {% if plato.tipo != "lugar" %}
                        <div class="form-check mb-2">
                          <input
                            type="checkbox"
                            id="plato{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                            name="plato_seleccionado"
                            value="{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}"
                            class="form-check-input"
                            {% if plato.elegido %}checked{% endif %}>
                          <label class="form-check-label" for="plato{{ plato.id_plato }}_{{ menu.el_dia_en_que_comemos|date:'Ymd' }}">
                            {{ plato.plato }}
                          </label>
                        </div>

                      {% else %}
                        <div class="text-muted fst-italic">››› {{ plato.plato }}</div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% empty %}
          <div class="alert alert-info">No hay platos asignados.</div>
        {% endfor %}

      </section>
    </div>

    <!-- Columna: Edita lista de compras -->
    
    <div class="col-12 col-md-6">


      <section>
        
        <h6 class="mb-1">Marcá lo que necesites comprar:</h6>

        {% if ingredientes_con_tengo_y_comentario %}
          <div class="card mr-3">
            <ul class="list-group list-group-flush">
              {% for ingrediente, valor in ingredientes_con_tengo_y_comentario.items %}
                <li class="list-group-item py-1 px-2">
                  <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">

                    <div class="form-check m-0 flex-grow-1">
                      <input 
                        class="form-check-input me-1" 
                        type="checkbox" 
                        id="ing-{{ forloop.counter }}"      {# ⬅️ IDs sin espacios #}
                        name="ingrediente_a_comprar"
                        value="{{ ingrediente }}"
                        {% if valor.estado == "no-tengo" %}checked{% endif %}>
                      <label class="form-check-label small" for="ing-{{ forloop.counter }}">
                        {{ ingrediente }}
                      </label>
                    </div>

                    <div class="input-group input-group-sm">
                      <input 
                        type="text"
                        id="ing-{{ forloop.counter }}_comentario"
                        name="{{ ingrediente }}_comentario"
                        value="{{ valor.comentario }}"
                        class="form-control"
                        placeholder="Comentario">
                      <button 
                        class="btn btn-outline-secondary" 
                        type="button" 
                        onclick="this.previousElementSibling.value=''">
                        &times;
                      </button>
                    </div>

                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="alert alert-info py-1 px-2 small">No hay ingredientes para editar</div>
        {% endif %}

        <div class="mt-3 mr-3">
        <!-- Botones: ir a la lista + compartir por WhatsApp -->
        <div class="d-flex gap-2">
          <!-- Ir a lista de compras -->
          <a href="{{ share_url }}"
          class="btn btn-outline-secondary flex-grow-1">
          Ir a lista de compras
        </a>

        <!-- Compartir link por WhatsApp -->
        <a href="https://wa.me/?text={{ share_url|urlencode }}"
            target="_blank" rel="noopener"
            class="btn btn-success d-inline-flex align-items-center justify-content-center"
            aria-label="Compartir por WhatsApp" title="Compartir por WhatsApp">
            <i class="bi bi-whatsapp"></i>
          </a>
        </div>


          <!-- (Opcional) input para copiar el link directamente -->
          <div class="input-group input-group-sm mt-2">
            <input class="form-control" value="{{ share_url }}" readonly onclick="this.select()">
            <button class="btn btn-outline-secondary" type="button"
                    onclick="navigator.clipboard?.writeText('{{ share_url }}')">
              Copiar link
            </button>
          </div>

      </section>
    </div>


<script>
(function () {
  const form = document.getElementById('frm-menu');
  if (!form) return;

  const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
  const origenInput = document.getElementById('post_origen');

  function setOrigen(v) {
    if (origenInput) origenInput.value = v; // "menu" o "ingredientes"
  }

  let t;
  const debounce = (fn, ms=350) => (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(null, args), ms);
  };

  async function autosave() {
    const fd = new FormData(form);
    await fetch(form.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrf },
      body: fd,
      credentials: 'same-origin'
    });
  }

  // --- Cambios de menú (requieren recarga) ---
  const afectaIngredientesSelector = [
    'input[name="plato_seleccionado"]',
    'input[name="variedad_seleccionada"]'
  ].join(',');

  form.querySelectorAll(afectaIngredientesSelector).forEach(el => {
    el.addEventListener('change', async () => {
      try {
        setOrigen('menu');
        await autosave();
        location.reload();
      } catch (e) {
        console.error('No se pudo guardar y recargar', e);
      }
    });
  });

  // --- Cambios de ingredientes (NO recarga inmediata) ---
  form.querySelectorAll('input[name="ingrediente_a_comprar"]').forEach(el => {
    el.addEventListener('change', async () => {
      try {
        setOrigen('ingredientes');
        await autosave();
      } catch(e) {}
    });
  });

  // comentarios: guardamos con debounce mientras escribís
  form.querySelectorAll('input[name$="_comentario"]').forEach(el => {
    const saveDebounced = debounce(async () => {
      try {
        setOrigen('ingredientes');
        await autosave();
      } catch(e) {}
    }, 500);

    el.addEventListener('input', saveDebounced);
    el.addEventListener('change', async () => {
      try {
        setOrigen('ingredientes');
        await autosave();
      } catch(e) {}
    });
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
  });
})();
</script>


{% endblock %}
